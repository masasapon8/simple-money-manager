        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
        document.getElementById('receipt').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒ" onclick="showImageModal('${e.target.result}')">
                        <div class="remove-image" onclick="removeImage()">âŒ ç”»åƒã‚’å‰Šé™¤</div>
                    `;
                };
                reader.readAsDataURL(file);
            }
        });

        // ç”»åƒå‰Šé™¤
        function removeImage() {
            document.getElementById('receipt').value = '';
            document.getElementById('imagePreview').innerHTML = '';
        }

        // ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showImageModal(src) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <span class="close-modal" onclick="this.parentElement.remove()">&times;</span>
                <div class="modal-content">
                    <img src="${src}" alt="ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒ">
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // å–å¼•è¿½åŠ ï¼ˆç”»åƒå¯¾å¿œç‰ˆï¼‰
        function addTransaction(type) {
            const description = document.getElementById('description').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const category = document.getElementById('category').value;
            const date = document.getElementById('date').value;
            const receiptFile = document.getElementById('receipt').files[0];

            if (!description || !amount || amount <= 0) {
                alert('å†…å®¹ã¨é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const transaction = {
                id: Date.now(),
                type: type,
                description: description,
                amount: amount,
                category: category,
                date: date,
                timestamp: new Date().toISOString()
            };

            // æ”¯å‡ºã®å ´åˆã®ã¿ç”»åƒã‚’ä¿å­˜
            if (type === 'expense' && receiptFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    transaction.receiptImage = e.target.result;
                    transactions.unshift(transaction);
                    saveData();
                    updateDisplay();
                    clearForm();
                };
                reader.readAsDataURL(receiptFile);
            } else {
                transactions.unshift(transaction);
                saveData();
                updateDisplay();
                clearForm();
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ˆç”»åƒå¯¾å¿œç‰ˆï¼‰
        function clearForm() {
            document.getElementById('description').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('receipt').value = '';
            document.getElementById('imagePreview').innerHTML = '';
        }

        // å±¥æ­´æ›´æ–°ï¼ˆç”»åƒå¯¾å¿œç‰ˆï¼‰
        function updateHistory() {
            const historyList = document.getElementById('historyList');

            if (transactions.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">ğŸ“</div>
                        <p>ã¾ã å–å¼•ãŒã‚ã‚Šã¾ã›ã‚“<br>åå…¥ã‚„æ”¯å‡ºã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                    </div>
                `;
                return;
            }

            historyList.innerHTML = transactions.map(transaction => `
                <div class="history-item">
                    <div class="item-info">
                        <div class="item-description">${transaction.description}</div>
                        <div class="item-details">
                            ${transaction.category} â€¢ ${new Date(transaction.date).toLocaleDateString('ja-JP')}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="item-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : '-'}Â¥${transaction.amount.toLocaleString()}
                        </div>
                        ${transaction.receiptImage ? `
                            <img src="${transaction.receiptImage}" 
                                 class="receipt-image" 
                                 alt="ãƒ¬ã‚·ãƒ¼ãƒˆ" 
                                 onclick="showImageModal('${transaction.receiptImage}')">
                        ` : ''}
                        <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');
        }
